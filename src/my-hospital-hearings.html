<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="my-hospital-hearing.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-hospital-hearings">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      #inspectImg{
        display:block;
        width:100%;
      }

      #inspectImgWrapper{
        position:relative;
      }

      #redDot{
        background:red;
        width:20px;
        height:20px;
        border-radius:50%;
        position:absolute;
        box-shadow: 0 0 5px red;
        opacity:0;
      }

      .card>div{
        margin: 30px 0;
      }

      .question{
        font-weight:200;
      }

      .answer{
        font-weight:700;
      }
    </style>

    <firebase-auth
    id="auth"
    user="{{user}}"
    on-error="handleError">
    </firebase-auth>

<!--     <firebase-query
        id="query"
        path="users/[[user.uid]]/hearings"
        data="{{hearings}}">
    </firebase-query>
 -->
    <div class="card">

      <template is="dom-repeat" items="[[hearings]]" as="hearing">
        <my-hospital-hearing params="[[hearing.key]]"></my-hospital-hearing>
      </template>

    </div>
  </template>

  <script>
    class MyHospitalHearings extends Polymer.Element {
      static get is() { return 'my-hospital-hearings'; }

      static get properties() {
        return {
          //hospital key in this case
          params: String,
          user: {
            type: Object,
            observer: 'loadHearings'
          },
          hearings: {
            type: Object,
            observer: 'consoleHearing'
          },
          listenQuery: {
            type: Object,
            observer: 'listenQueryChanged'
          },
          newestQuestionKey: {
            type: String,
            observer: 'listenForNewHearings'
          }
        }
      }

      consoleHearing(){
        console.log("console hearings", this.hearings)
      }

      loadHearings(){
        // this.hearings=[]
        var htemp = this.hearings
        this.hearings = []
        // this.hearings.push({key: "some"})
        // console.log(this.hearings)
        // return
        console.log("load called")
        const that = this
        if(!this.user){
          return
        }
        const ref = window.firebase.database().ref().child("users/" + this.user.uid + "/hearings")
        ref.once('value', function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            var childKey = childSnapshot.key
            // var childData = childSnapshot.val()
            // childKey = "some some"
            console.log("childKey", childKey)
            const newkey = {key: childKey}

            // var temp = that.hearings
            // temp.push(key)
            console.log("htempt pre", htemp)
            htemp.push(newkey)
            console.log("htemp", htemp)
            // console.log("temp", temp)
            // temp = [{key: "some"}]
            that.hearings = htemp
            console.log("final", that.hearings)

          })
        })
      }

      listenQueryChanged(oldQuery, newQuery){
          if (oldQuery) {
            oldQuery.off()
            // oldQuery.off('value', this.__onFirebaseValue, this);
          }
      }

      listenForNewHearings(){
        const that = this
        const firebase = window.firebase
        this.listenQuery = firebase.database().ref("users/" + this.user.uid + "/hearings").startAt(null, this.newestQuestionKey)
        this.listenQuery.on('value', function(snapshot) {
          const snap = snapshot.val()
          cnosole.log("listenForNewHearings", snap)
        })
      }

      // _computeSort(a, b) {
      //   // http://stackoverflow.com/questions/33953938/polymer-1-0-sorting-dom-repeat
      //   if (a.$key == b.$key) {
      //     return 0;
      //   }
      //   return a.$key > b.$key ? -1 : 1;
      // }

    }

    window.customElements.define(MyHospitalHearings.is, MyHospitalHearings);
  </script>
</dom-module>
